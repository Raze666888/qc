# 问卷截止时间问题调试指南

## 问题描述
用户创建问卷时设置了截止时间，但在前端页面显示"未设置截止时间"。

## 已完成的修复

### 1. 后端修复

#### ① 实体类添加显式字段映射
**文件**: `qc-backend/src/main/java/com/qc/entity/Questionnaire.java`
```java
@TableField("deadline")
private LocalDateTime deadline;
```

**文件**: `qc-backend/src/main/java/com/qc/vo/QuestionnaireVO.java`
```java
@com.baomidou.mybatisplus.annotation.TableField("deadline")
private LocalDateTime deadline;
```

#### ② 日期解析修复
**文件**: `qc-backend/src/main/java/com/qc/service/QuestionnaireService.java`

创建问卷时（第73-84行）：
```java
// 处理 deadline 字段 - 支持格式: YYYY-MM-DD HH:mm:ss
if (questionnaireData.get("deadline") != null && !questionnaireData.get("deadline").toString().isEmpty()) {
    try {
        String deadlineStr = questionnaireData.get("deadline").toString();
        java.time.format.DateTimeFormatter formatter = java.time.format.DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss");
        questionnaire.setDeadline(java.time.LocalDateTime.parse(deadlineStr, formatter));
        log.info("截止时间解析成功: {}", deadlineStr);
    } catch (Exception e) {
        log.error("日期解析失败: {}, 错误: {}", questionnaireData.get("deadline"), e.getMessage());
    }
}
```

更新问卷时（第134-147行）：同样使用DateTimeFormatter解析

#### ③ 添加调试日志
**getQuestionnaireDetail方法**（第416、422行）：
```java
log.info("查询到问卷: id={}, title={}, deadline={}", questionnaire.getId(), questionnaire.getTitle(), questionnaire.getDeadline());
log.info("VO中deadline字段: {}", vo.getDeadline());
```

**getPublicQuestionnairePage方法**（第383行）：
```java
log.info("首页问卷列表: id={}, title={}, deadline={}", q.getId(), q.getTitle(), q.getDeadline());
```

### 2. 前端修复

#### ① 添加调试日志
**QuestionnaireDetail.vue**（第178-195行）：
```javascript
console.log('从API获取的问卷数据:', data)
console.log('截止时间字段:', data.deadline)
console.log('设置后的questionnaire对象:', questionnaire)
```

**HomePage.vue**（第210-214行）：
```javascript
console.log('首页问卷列表数据:', newRecords)
newRecords.forEach(q => {
  console.log(`问卷 ${q.id}: ${q.title}, 截止时间:`, q.deadline)
})
```

#### ② 显示优化
**HomePage.vue**（第99-104行）：
```vue
<span class="deadline" v-if="q.deadline">
  {{ formatDeadline(q.deadline) }}
</span>
<span class="deadline-no-set" v-else>
  未设置截止时间
</span>
```

---

## 调试步骤

### 步骤1: 验证数据库

执行SQL查询：
```sql
-- 查看表结构
DESCRIBE questionnaire;

-- 查看是否有deadline字段
SHOW COLUMNS FROM questionnaire LIKE 'deadline';

-- 查看最近的问卷及其截止时间
SELECT id, title, deadline, create_time
FROM questionnaire
WHERE deleted = 0
ORDER BY create_time DESC
LIMIT 10;
```

**预期结果**：
- 表中应该有`deadline`字段，类型为`DATETIME`
- 如果刚创建了问卷，应该能看到截止时间值

**如果没有deadline字段**，执行：
```sql
ALTER TABLE questionnaire ADD COLUMN deadline DATETIME COMMENT '截止时间' AFTER category;
```

### 步骤2: 检查后端日志

重新编译并启动后端：
```bash
cd qc-backend
mvn clean package
mvn spring-boot:run
```

**创建问卷时检查日志**：
```
截止时间解析成功: 2025-12-29 15:30:00
准备插入问卷: title=xxx, userId=xxx
问卷插入成功, ID: xxx
```

**查询问卷时检查日志**：
```
查询到问卷: id=1, title=测试问卷, deadline=2025-12-29T15:30:00
VO中deadline字段: 2025-12-29T15:30:00
```

**如果看到null值**，说明数据库中deadline为NULL

### 步骤3: 检查前端控制台

打开浏览器开发者工具（F12），查看Console标签页。

**创建问卷后**：
```
从API获取的问卷数据: {id: 1, title: "测试问卷", deadline: "2025-12-29T15:30:00", ...}
截止时间字段: "2025-12-29T15:30:00"
设置后的questionnaire对象: {deadline: "2025-12-29T15:30:00", ...}
```

**首页问卷列表**：
```
首页问卷列表数据: [{id: 1, title: "测试问卷", deadline: "2025-12-29T15:30:00"}, ...]
问卷 1: 测试问卷, 截止时间: "2025-12-29T15:30:00"
```

**如果deadline为null或undefined**，说明后端没有正确返回数据

### 步骤4: 测试完整流程

1. **创建新问卷**
   - 访问创作者中心
   - 点击"创建问卷"
   - 填写基本信息并选择截止时间（例如：2025-12-29 15:30:00）
   - 添加问题并保存草稿

2. **检查后端日志**
   - 查看"截止时间解析成功"日志
   - 确认解析的日期格式正确

3. **查询数据库**
   ```sql
   SELECT id, title, deadline FROM questionnaire WHERE id = <刚创建的问卷ID>;
   ```
   - 确认deadline字段有值

4. **查看前端显示**
   - 刷新首页，查看问卷列表
   - 点击问卷查看详情页
   - 检查是否正确显示截止时间

---

## 常见问题和解决方案

### 问题1: 数据库中deadline为NULL

**原因**：日期解析失败，但没有抛出异常

**检查**：
1. 查看后端日志是否有"日期解析失败"的ERROR日志
2. 检查前端发送的日期格式是否为`YYYY-MM-DD HH:mm:ss`

**解决方案**：
- 确保前端使用`value-format="YYYY-MM-DD HH:mm:ss"`
- 后端使用DateTimeFormatter正确解析

### 问题2: 后端有deadline，但前端收到null

**原因**：
1. 序列化时LocalDateTime格式问题
2. VO对象字段映射错误

**检查**：
1. 查看后端日志"VO中deadline字段"
2. 检查QuestionnaireVO是否正确设置@TableField注解

**解决方案**：
- 添加Jackson配置序列化LocalDateTime
- 或在VO字段上使用@JsonFormat注解

### 问题3: 前端接收到数据，但页面显示"未设置截止时间"

**原因**：
1. 响应式数据未更新
2. 判断条件错误

**检查**：
1. 查看浏览器控制台的调试日志
2. 确认data.deadline有值

**解决方案**：
- 使用Vue3的reactive或ref正确声明变量
- 使用Object.assign正确赋值

---

## 数据流验证清单

- [ ] 前端选择日期 → 发送正确格式（YYYY-MM-DD HH:mm:ss）
- [ ] 后端接收 → 解析成功（日志显示"截止时间解析成功"）
- [ ] 保存到数据库 → deadline字段有值
- [ ] 查询数据库 → deadline字段正确返回
- [ ] 转换为VO → deadline字段正确复制
- [ ] 序列化响应 → JSON包含deadline字段
- [ ] 前端接收 → data.deadline有值
- [ ] 赋值给响应式对象 → questionnaire.deadline更新
- [ ] 页面渲染 → 正确显示截止时间

---

## 配置建议

### 后端 application.yml
确保Jackson正确序列化LocalDateTime：
```yaml
spring:
  jackson:
    date-format: yyyy-MM-dd HH:mm:ss
    time-zone: GMT+8
    serialization:
      write-dates-as-timestamps: false
```

### 或在VO字段上使用注解
```java
@JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss", timezone = "GMT+8")
private LocalDateTime deadline;
```

---

## 测试用例

### 测试用例1: 创建带截止时间的问卷
1. 填写问卷信息
2. 选择截止时间：2025-12-30 23:59:59
3. 保存草稿
4. 验证：数据库deadline字段值为2025-12-30 23:59:59

### 测试用例2: 创建不带截止时间的问卷
1. 填写问卷信息
2. 不选择截止时间
3. 保存草稿
4. 验证：数据库deadline字段值为NULL，前端显示"未设置截止时间"

### 测试用例3: 更新问卷截止时间
1. 编辑已有问卷
2. 修改截止时间：2025-12-31 23:59:59
3. 保存修改
4. 验证：数据库deadline字段值已更新

---

## 联系方式

如果按照以上步骤仍然无法解决问题，请提供：
1. 后端完整日志（包含创建和查询）
2. 前端控制台日志
3. 数据库查询结果
4. 浏览器Network面板的API响应
